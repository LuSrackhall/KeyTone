# 技术设计：签名图片异步删除（重命名标记 + 启动清理按文件名）

## 现状

- 图片写入：创建/更新/导入签名时，将图片保存到 `ConfigPath/signature/<sha1>.<ext>`，并把**完整文件路径**写入加密的签名数据字段 `CardImage`。
  - 这里的 `<sha1>` 并非图片内容哈希：实际是对 `id|name|originalImageName|timestamp`（导入为 `id|name|importFileName|timestamp`）的字符串做 SHA-1。
  - 因此系统不做图片去重/共享：每次保存/导入都会生成新文件名，正常流程不会出现多个签名引用同一个图片文件。
- 删除签名：当前删除接口只删除配置中的签名条目，不处理图片。
- 启动清理：`CleanupOrphanCardImages` 会解密所有签名条目，收集 `CardImage` 路径作为“有效集合”，然后删除目录中不在集合内的文件。

## 问题根因

- 启动清理依赖解密成功。
- 构建密钥变更导致历史签名解密失败时，“有效集合”不完整，清理会把仍应保留的图片误删。

## 设计原则

- **异步删除保持异步**：删除交互不做 `os.Remove`，只做“可回滚”的标记操作。
- **删除对象由文件名决定**：启动清理不依赖配置、不依赖解密。
- **一致性优先**：如果图片无法被标记（重命名失败），则拒绝删除配置条目。

## 新行为设计

### 1) 删除接口：先标记、后删配置

流程（针对有图片的签名）：

1. 读取配置中的签名条目。
2. 解密签名数据，得到 `CardImage` 路径。
3. 若 `CardImage` 为空：直接删除配置条目。
4. 若 `CardImage` 非空：
   - 校验路径必须位于 `ConfigPath/signature` 目录下（避免错误路径或路径注入）。
   - 若 `CardImage` 为跨平台格式（如 Windows `\\` 反斜杠路径）或路径不可用：回退按 basename 在 `ConfigPath/signature` 下定位。
   - 若最终仍无法定位图片文件：返回失败并拒绝删除配置条目（保持一致性）。
   - 重命名为 `Delete___<original_filename>`（即在原文件名前增加固定前缀 `Delete___`）。
5. 重命名成功后，删除配置条目并返回成功。
6. 重命名失败：返回失败，配置不变。

> 说明：本变更不要求对“解密失败”的历史签名提供删除能力；删除操作在无法安全定位图片时失败是可接受的保守策略。

### 2) 启动清理：只清理 Delete___* 文件

- 扫描 `ConfigPath/signature` 目录，删除所有文件名以 `Delete___` 开头的文件。
- 不再：
  - 遍历配置签名列表
  - 解密签名数据
  - 比对有效路径集合

## 兼容性

- 对现有图片文件命名无要求。
- 对配置结构无要求（不新增字段）。
- 仅改变“删除签名”和“启动清理”的行为语义。

## 失败语义（建议）

- 重命名失败：删除 API 返回失败并不删配置。
- 图片无法定位/不存在：返回失败并不删配置（避免“配置已删但图片未标记”的不一致）。

