# 提案：更新签名图片的异步删除机制（基于重命名标记）

## 背景与问题

当前签名名片图片的删除采用“启动后异步清理”的方式：启动时扫描 `ConfigPath/signature` 目录，将其与配置文件中签名列表解析出的图片路径集合进行对比，删除不在集合中的文件。

该机制存在关键缺陷：

- 清理逻辑依赖“可解密签名数据以得到图片路径”。当构建密钥变更导致历史签名数据无法解密时，有效路径集合可能为空或不完整，从而把大量仍应保留的图片误判为“孤立文件”并删除。
- 之前的“只要存在一个解析不通过就不删”的兜底会引入反向问题：只要配置中混入一个不同密钥的签名项，可能导致清理逻辑永远不删除任何文件。

## 目标

- 保留“异步删除”的总体设计（删除动作不在用户交互主流程做实际 `os.Remove`）。
- 删除签名时，确保其名片图片一定会在后续被清理，而不再依赖启动时解密配置来决定删除对象。
- 当重命名（标记删除）失败时，删除 API 直接返回失败，并且不删除配置中的签名条目，保证一致性。
- 启动后的清理逻辑改为“只按文件名决定删除”，不再依赖解密签名数据。

## 非目标

- 不引入同步删除（先删文件再删配置）的流程。
- 不做文件目录隔离或改变图片存储目录结构。
- 不尝试在启动清理阶段恢复或推断无法解密的签名图片归属。

## 方案概述

### 删除签名（仍为异步删除，但增加“重命名标记”）

- 当调用 `POST /signature/delete` 删除签名时：
  - 后端从配置中读取该签名条目并解析其名片图片路径（若签名没有图片则跳过）。
  - 后端定位图片文件时，优先使用签名数据中的路径；若路径为跨平台格式（如 Windows 反斜杠）或不可用，则回退按文件名（basename）在 `ConfigPath/signature` 下查找。
  - 若图片文件存在，先将其重命名为 `Delete___<original_filename>`（即在原文件名前增加固定前缀 `Delete___`）。
  - **只有当重命名成功（或无图片）时**，才删除配置中的签名条目并返回成功。
  - 若重命名失败，则返回失败，并保留配置条目不变。

### 启动清理（按文件名前缀删除）

- 启动后清理任务仅扫描 `ConfigPath/signature` 目录：
  - 删除所有文件名以 `Delete___` 开头的文件。
  - 不再从配置读取签名列表、不再解密签名数据、不再比对“有效路径集合”。

## 风险与应对

- **重命名失败**：删除 API 会失败且不删除配置条目，用户可重试；不会出现“配置已删但图片未标记导致残留”的不一致。
- **旧版本遗留的孤立图片**：此方案不再清理由旧逻辑产生的“未引用但未标记”的文件；但在新行为下，正常删除签名将产生标记文件并被后续清理。
- **多签名共享同一图片文件**：经检查创建/更新/导入流程，图片文件名不是按“图片内容”去重，而是由 `id|name|originalImageName|timestamp`（导入为 `id|name|importFileName|timestamp`）参与生成，因此正常流程不会产生共享图片文件；若用户手工篡改配置导致共享引用，则删除其中一个签名的图片标记会影响其他引用者（异常数据，非本变更的兼容目标）。

## 验收标准

- 密钥变更后启动应用：不会因无法解密旧签名而误删 `ConfigPath/signature` 下的非 `Delete___*` 文件。
- 删除带图片的签名：
  - 当图片重命名成功：签名配置条目被删除；启动后清理会删除该 `Delete___*` 文件。
  - 当图片重命名失败：API 返回失败；签名配置条目不会被删除。
- 删除不带图片的签名：API 正常删除配置条目。

