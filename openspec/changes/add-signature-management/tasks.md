# 实现任务清单

本文档列出了签名管理系统的所有实现任务，按照依赖关系排序。标记为 🔄 的任务可以并行执行。

## 阶段 1：基础设施（第 1-2 周）

### 🔄 任务 1.1：后端加密模块

**负责人**：后端开发

**依赖**：无

**验收标准**：

- [x] 创建 `sdk/signature/encryption.go`
- [x] 实现 `GenerateProtectCode() (string, error)` 函数（使用 go-nanoid）
- [x] 实现 `EncryptSignature(data string) (string, error)` 函数
- [x] 实现 `DecryptSignature(encryptedData string) (string, error)` 函数
- [x] 使用 AES-256-GCM 模式
- [x] 编写单元测试，覆盖率 > 90%
- [x] 测试边界情况：空字符串、超长字符串、特殊字符

**预计工时**：5 小时

---

### 🔄 任务 1.2：前端签名服务层

**负责人**：前端开发

**依赖**：任务 1.2

**验收标准**：

- [x] 创建 `frontend/src/boot/query/signature-query.ts`
- [x] 实现 `getAllSignatures(): Promise<SignatureManager>`
- [x] 实现 `createSignature(data): Promise<Signature>`
- [x] 实现 `updateSignature(signature): Promise<void>`
- [x] 实现 `deleteSignature(id): Promise<void>`
- [x] 实现 `exportSignature(id): Promise<Blob>`
- [x] 实现 `importSignature(file): Promise<Signature>`
- [x] 添加错误处理和类型检查
- [ ] 编写单元测试

**预计工时**：8 小时

---

### 🔄 任务 1.3：TypeScript 类型定义

**负责人**：前端开发

**依赖**：无

**验收标准**：

- [x] 创建 `frontend/src/types/signature.ts`
- [x] 定义 `Signature` 接口（id, name, intro, cardImage，无 createdAt 和 protectCode）
- [x] 定义 `SignatureManager` 接口
- [x] 定义 `SignatureFile` 接口（导出文件格式，cardImage 为 Base64）
- [x] 定义 `SignatureErrorCode` 枚举
- [x] 添加 JSDoc 注释

**预计工时**：2 小时

---

## 阶段 2：后端 API 实现（第 2-3 周）

### 任务 2.1：签名 CRUD API 端点

**负责人**：后端开发

**依赖**：任务 1.1

**验收标准**：

- [x] 在 `sdk/server/signature_handlers.go` 中添加签名相关路由
- [x] 实现 `POST /signature/create`（接收 Base64 图片，生成 ID 和保护码，加密存储）
- [x] 实现 `GET /signature/list`（解密并返回所有签名）
- [x] 实现 `PUT /signature/update`（接收 Base64 图片，更新签名数据）
- [x] 实现 `DELETE /signature/delete/:id`（删除签名）
- [x] 实现 `GET /signature/export/:id`（返回 .ktsign 格式，图片转 Base64）
- [x] 实现 `POST /signature/import`（接收 .ktsign 文件，图片恢复为文件）
- [x] 所有 API 都使用 `sdk/signature/encryption.go` 进行加解密
- [x] 添加输入验证和错误处理
- [ ] 编写 API 集成测试

**预计工时**：12 小时

---

### 任务 2.2：图片存储和访问

**负责人**：后端开发

**依赖**：无

**验收标准**：

- [x] 在应用启动时创建 `signatures/card_images/` 目录
- [x] 实现图片 Base64 解码和保存逻辑（使用 SHA-256 哈希命名）
- [x] 实现 `GET /signature/image/:filename` 端点（返回图片二进制数据）
- [x] 设置正确的 Content-Type 响应头
- [x] 添加缓存控制头（Cache-Control）
- [x] 防止路径遍历攻击（验证文件名合法性）
- [x] 处理文件不存在的情况
- [x] 添加错误处理和日志记录
- [ ] 编写 API 测试

**预计工时**：5 小时

---

### 任务 2.3：配置文件结构扩展

**验收标准**：

- [x] 创建 `GET /signature/image/:filename` 端点
- [x] 设置正确的 `Content-Type` 响应头
- [x] 添加缓存控制头
- [x] 处理文件不存在的情况
- [ ] 编写 API 测试
- [x] 添加缓存控制头
- [x] 处理文件不存在的情况
- [ ] 编写 API 测试

**预计工时**：3 小时

---

## 阶段 3：前端UI组件（第 3-4 周）

### 任务 2.3：配置文件结构扩展（重复项整合）

**负责人**：后端开发

**依赖**：任务 1.1

**验收标准**：

- [ ] 在 `sdk/config/config.go` 中添加签名管理器字段处理
- [ ] 支持 `signature_manager` 键的读写（加密存储）
- [ ] 确保向后兼容（旧配置文件返回空对象）
- [ ] 添加日志记录
- [ ] 编写集成测试

**预计工时**：3 小时

---

### 任务 2.4：前端 SSE 数据处理适配

**负责人**：前端开发

**依赖**：任务 1.2, 任务 2.3

**重要说明**：现有代码已实现 SSE 全量配置数据推送机制，无需在后端新增通知逻辑。此任务仅需在前端现有的 SSE 监听逻辑中添加签名数据处理。

**验收标准**：

- [x] 在现有的 SSE 监听器中（`App.vue`）添加 `signature_manager` 字段处理
- [x] 从全量配置数据中识别签名数据变更并刷新前端签名状态（通过已实现的列表 API 获取解密后的数据）
- [x] 更新前端签名状态（Pinia store）
- [x] 确保 Vue 响应式系统自动更新所有使用签名数据的组件
- [x] **不需要**实现单独的 `signature_updated` 标志检测
- [ ] **不需要**调用 `GET /signature/list` API 重新获取数据
- [x] 测试多窗口/多标签页数据同步（依赖现有 SSE 重连机制）
- [x] 在现有的 SSE 监听器中（`App.vue`）添加 `signature_manager` 字段处理
- [x] 从全量配置数据中识别签名数据变更并刷新前端签名状态（通过已实现的列表 API 获取解密后的数据）
- [x] 更新前端签名状态（Pinia store）
- [x] 确保 Vue 响应式系统自动更新所有使用签名数据的组件
- [x] **不需要**实现单独的 `signature_updated` 标志检测
- [ ] **不需要**调用 `GET /signature/list` API 重新获取数据
- [x] 测试多窗口/多标签页数据同步（依赖现有 SSE 重连机制）

**实现示例**：

```typescript
// 在现有的 SSE 监听逻辑中添加
eventSource.addEventListener('message', (event) => {
  const fullConfig = JSON.parse(event.data);
  
  // 新增：处理签名数据
  if (fullConfig.signature_manager) {
    signatureStore.updateSignatures(fullConfig.signature_manager);
  }
  
  // 现有逻辑：处理其他配置...
});
```

**预计工时**：1.5 小时（从原 2 小时减少，因为后端无需新增代码）

---

## 阶段 3：前端UI组件（第 4-5 周）

### 🔄 任务 3.1：签名管理页面

**负责人**：前端开发

**依赖**：任务 1.2, 任务 1.3

**验收标准**：

- [x] 创建 `frontend/src/pages/Signature_management_page.vue`
- [ ] **列表项布局**：名片图片在左侧（约 80x80px），签名信息在右侧为主要展示
- [ ] **名片图片功能**：点击小图像打开预览对话框查看大图，不在列表项点击时进入编辑
- [ ] **点击签名名称/介绍区域进入编辑**：而不是点击图片进编辑
- [x] 实现签名列表展示（网格布局，固定尺寸适配）
- [x] 图片通过 `/signature/image/:filename` 接口加载
- [x] 实现"创建签名"按钮
- [x] 实现签名项点击编辑功能
- [x] 实现签名项删除功能（带确认）
- [ ] **编辑/删除/导出按钮位置**：位于列表项右侧
- [x] 实现空状态提示
- [x] 添加加载状态和错误状态
- [x] 页面和对话框模式双适配
- [x] 添加 i18n 国际化

**预计工时**：14 小时

---

### 任务 3.2：签名管理对话框

**负责人**：前端开发

**依赖**：任务 3.1

**验收标准**：

- [ ] 创建 `frontend/src/components/SignatureManagementDialog.vue`（非必需，页面已完成）
- [ ] 支持页面模式和对话框模式切换
- [ ] 对话框模式添加 `backdrop-filter="invert(70%)"`
- [ ] 复用签名管理页面的核心逻辑
- [ ] 添加关闭按钮
- [ ] 添加 i18n 国际化

**预计工时**：4 小时（可选，页面模式已满足需求）

---

### 任务 3.3：签名创建/编辑对话框

**负责人**：前端开发

**依赖**：任务 1.3, 任务 1.4

**验收标准**：

- [x] 创建 `frontend/src/components/SignatureFormDialog.vue`
- [x] 实现签名名称输入（必填，1-50字符）
- [x] 实现个人介绍输入（选填，0-500字符）
- [x] 实现名片图片上传（带预览）
- [ ] **图片选择器在表单字段下方**（不是上方）
- [ ] **图片快速预览显示在选择器下方**（而不是上方）
- [ ] **快速预览区域可点击，打开大图预览对话框**
- [ ] **图片格式支持范围**：不受严格限制，仅支持 webview 支持的图片格式
- [x] 保护码由后端自动生成（前端不显示）
- [x] 创建模式：显示"创建"按钮
- [x] 编辑模式：显示"更新"按钮
- [x] 添加表单验证
- [x] 添加 `backdrop-filter="invert(70%)"`
- [x] 添加 i18n 国际化

**预计工时**：10 小时

---

### 🔄 任务 3.4：签名导入对话框

**负责人**：前端开发

**依赖**：任务 1.3

**验收标准**：

- [ ] 创建 `frontend/src/components/SignatureImportDialog.vue`
- [ ] 实现文件选择功能（.ktsign 文件）
- [ ] 解析并显示签名预览
- [ ] 检测签名冲突，显示覆盖确认对话框
- [ ] 显示导入进度
- [ ] 添加错误处理和用户友好的错误提示
- [ ] 添加 `backdrop-filter="invert(70%)"`
- [ ] 添加 i18n 国际化

**预计工时**：8 小时

---

### 🔄 任务 3.5：签名导出功能

**负责人**：前端开发

**依赖**：任务 1.3

**验收标准**：

- [ ] 在签名列表项添加"导出"按钮
- [ ] 调用 `window.showSaveFilePicker()` API
- [ ] 生成 `.ktsign` 文件
- [ ] 计算 SHA-256 校验和
- [ ] 保存文件到用户选择的位置
- [ ] 显示导出成功/失败提示
- [ ] 添加旧浏览器降级方案（使用 `<a download>`）

**预计工时**：6 小时

---

### 🔄 任务 3.6：图片预览组件

**负责人**：前端开发

**依赖**：无

**验收标准**：

- [ ] 创建 `frontend/src/components/ImagePreviewDialog.vue`
- [ ] 显示全尺寸图片
- [ ] 支持图片缩放和平移
- [ ] 添加关闭按钮
- [ ] 添加 `backdrop-filter="invert(70%)"`
- [ ] 添加加载状态和错误状态

**预计工时**：4 小时

---

## 阶段 4：专辑集成（第 5 周）

### 任务 4.1：专辑文件格式扩展

**负责人**：后端开发

**依赖**：任务 1.1

**验收标准**：

- [ ] 修改 `tools/ktalbum-tools/utils/album.go`
- [ ] 在 `Album` 结构体中添加 `Signatures` 字段
- [ ] 更新序列化和反序列化逻辑
- [ ] 确保向后兼容（旧版本专辑文件）
- [ ] 编写单元测试

**预计工时**：4 小时

---

### 任务 4.2：签名选择对话框

**负责人**：前端开发

**依赖**：任务 1.3, 任务 3.1

**验收标准**：

- [ ] 创建 `frontend/src/components/SignatureSelectDialog.vue`
- [ ] 显示所有可用签名列表
- [ ] 支持单选和多选模式
- [ ] 添加"不签名"选项
- [ ] 添加"管理签名"按钮（打开签名管理对话框）
- [ ] 显示签名预览（名称、介绍、名片图片）
- [ ] 添加 `backdrop-filter="invert(70%)"`
- [ ] 添加 i18n 国际化

**预计工时**：8 小时

---

### 任务 4.3：专辑导出流程集成

**负责人**：前端开发

**依赖**：任务 4.2

**验收标准**：

- [ ] 修改专辑导出页面（假设在 `frontend/src/pages/AlbumExport.vue`）
- [ ] 在导出流程中添加签名选择步骤
- [ ] 将选中的签名嵌入专辑文件
- [ ] 更新导出 API 调用（传递签名数据）
- [ ] 显示签名状态（已签名/未签名）
- [ ] 测试完整的导出流程

**预计工时**：6 小时

---

## 阶段 5：国际化（第 6 周）

### 任务 5.1：中文翻译

**负责人**：前端开发

**依赖**：任务 3.1-3.6, 任务 4.2

**验收标准**：

- [ ] 在 `frontend/src/i18n/zh-CN/index.json` 中添加所有签名相关的键
- [ ] 包含所有页面、对话框、按钮、提示的翻译
- [ ] 包含所有错误消息的翻译
- [ ] 审核翻译质量，确保语言自然流畅

**预计工时**：4 小时

---

### 任务 5.2：英文翻译

**负责人**：前端开发

**依赖**：任务 5.1

**验收标准**：

- [ ] 在 `frontend/src/i18n/en-US/index.json` 中添加所有签名相关的键
- [ ] 包含所有页面、对话框、按钮、提示的翻译
- [ ] 包含所有错误消息的翻译
- [ ] 审核翻译质量，确保语法正确

**预计工时**：4 小时

---

### 任务 5.3：i18n 测试

**负责人**：QA

**依赖**：任务 5.1, 任务 5.2

**验收标准**：

- [ ] 在中文环境下测试所有功能
- [ ] 在英文环境下测试所有功能
- [ ] 验证所有文本都已翻译（无翻译键直接显示）
- [ ] 验证翻译准确性和一致性
- [ ] 记录并修复翻译问题

**预计工时**：4 小时

---

## 阶段 6：测试与优化（第 7-8 周）

### 任务 6.1：单元测试

**负责人**：开发团队

**依赖**：任务 1.1-1.4, 任务 2.1-2.4

**验收标准**：

- [ ] 后端加密模块测试覆盖率 > 90%
- [ ] 前端加密工具类测试覆盖率 > 90%
- [ ] 前端签名服务层测试覆盖率 > 80%
- [ ] 所有边界情况都有测试
- [ ] 所有错误路径都有测试

**预计工时**：12 小时

---

### 任务 6.2：集成测试

**负责人**：QA

**依赖**：任务 3.1-3.6, 任务 4.1-4.3

**验收标准**：

- [ ] 测试完整的签名创建流程
- [ ] 测试完整的签名编辑流程
- [ ] 测试完整的签名删除流程
- [ ] 测试完整的签名导入/导出流程
- [ ] 测试完整的专辑签名流程
- [ ] 测试 SSE 全量配置数据推送后签名数据自动同步（验证现有机制）
- [ ] 测试多窗口/多标签页签名数据实时同步
- [ ] 测试跨页面导航
- [ ] 测试错误场景（网络错误、文件损坏等）

**预计工时**：16 小时

---

### 任务 6.3：E2E 测试

**负责人**：QA

**依赖**：任务 6.2

**验收标准**：

- [ ] 使用 Playwright 编写 E2E 测试脚本
- [ ] 覆盖所有用户操作路径
- [ ] 测试多语言环境
- [ ] 测试不同操作系统（Windows, macOS, Linux）
- [ ] 测试性能（加载时间、响应时间）

**预计工时**：20 小时

---

### 任务 6.4：性能优化

**负责人**：开发团队

**依赖**：任务 6.3

**验收标准**：

- [ ] 实现签名数据缓存（5秒 TTL）
- [ ] 优化图片加载（懒加载、压缩）
- [ ] 优化加密/解密性能（使用 Web Workers）
- [ ] 减少不必要的 API 调用
- [ ] 页面加载时间 < 2 秒
- [ ] 签名操作响应时间 < 500ms

**预计工时**：12 小时

---

### 任务 6.5：安全审计

**负责人**：安全工程师

**依赖**：任务 6.1-6.3

**验收标准**：

- [ ] 审计加密实现（AES-256-GCM）
- [ ] 审计输入验证（XSS、SQL注入）
- [ ] 审计文件上传安全性
- [ ] 审计权限控制
- [ ] 修复发现的安全问题
- [ ] 生成安全审计报告

**预计工时**：8 小时

---

## 阶段 7：文档与发布（第 8 周）

### 🔄 任务 7.1：用户文档

**负责人**：技术写作

**依赖**：任务 6.1-6.5

**验收标准**：

- [ ] 编写签名管理功能用户指南
- [ ] 添加屏幕截图和操作步骤
- [ ] 编写常见问题解答（FAQ）
- [ ] 翻译为中文和英文
- [ ] 发布到文档网站

**预计工时**：8 小时

---

### 🔄 任务 7.2：开发者文档

**负责人**：开发团队

**依赖**：任务 6.1-6.5

**验收标准**：

- [ ] 更新 API 文档
- [ ] 添加签名数据结构说明
- [ ] 添加加密算法说明
- [ ] 添加代码示例
- [ ] 发布到开发者文档网站

**预计工时**：6 小时

---

### 任务 7.3：CHANGELOG 更新

**负责人**：项目经理

**依赖**：任务 6.1-6.5

**验收标准**：

- [ ] 在 `CHANGELOG.md` 中添加新版本条目
- [ ] 列出所有新功能
- [ ] 列出所有 API 变更
- [ ] 添加迁移指南（如有必要）

**预计工时**：2 小时

---

### 任务 7.4：版本发布

**负责人**：DevOps

**依赖**：任务 7.1-7.3

**验收标准**：

- [ ] 更新版本号（遵循语义化版本）
- [ ] 生成发布包（Windows, macOS, Linux）
- [ ] 上传到 GitHub Releases
- [ ] 发布更新公告
- [ ] 通知用户

**预计工时**：4 小时

---

## 总结

### 时间估算

| 阶段               | 预计工时       | 日历周数 |
| ------------------ | -------------- | -------- |
| 阶段 1：基础设施   | 17 小时        | 1-2 周   |
| 阶段 2：后端存储   | 13.5 小时      | 2 周     |
| 阶段 3：前端UI组件 | 52 小时        | 3-4 周   |
| 阶段 4：专辑集成   | 18 小时        | 5 周     |
| 阶段 5：国际化     | 12 小时        | 6 周     |
| 阶段 6：测试与优化 | 68 小时        | 7-8 周   |
| 阶段 7：文档与发布 | 20 小时        | 8 周     |
| **总计**           | **200.5 小时** | **8 周** |

**注**：阶段 2 从 15 小时减少到 13.5 小时，因为 SSE 通知机制无需后端额外开发（现有代码已实现全量配置推送）。

### 人力分配

- **后端开发**：1 人，全职
- **前端开发**：1 人，全职
- **QA 工程师**：1 人，从第 6 周开始全职
- **技术写作**：1 人，兼职（第 8 周）
- **DevOps**：1 人，兼职（第 8 周）

### 关键里程碑

- **M1 (第 2 周末)**：基础设施和后端存储完成
- **M2 (第 4 周末)**：前端UI组件完成
- **M3 (第 5 周末)**：专辑集成完成
- **M4 (第 6 周末)**：国际化完成
- **M5 (第 8 周末)**：测试、文档完成，准备发布

### 风险管理

| 风险                  | 概率 | 影响 | 缓解措施                                  |
| --------------------- | ---- | ---- | ----------------------------------------- |
| 加密性能问题          | 中   | 高   | 提前进行性能测试，准备 Web Workers 方案   |
| 文件格式不兼容        | 低   | 高   | 严格遵循 JSON Schema，添加版本检测        |
| 图片上传失败          | 中   | 中   | 添加重试机制，提供详细错误提示            |
| SSE 连接不稳定        | 低   | 中   | 依赖现有的 SSE 自动重连机制，无需额外实现 |
| 浏览器 API 兼容性问题 | 低   | 中   | 提供降级方案（如 `<a download>`）         |

### 验收标准

所有任务完成后，需满足以下条件才能发布：

- [ ] 所有单元测试通过
- [ ] 所有集成测试通过
- [ ] 所有 E2E 测试通过
- [ ] 代码审查完成
- [ ] 安全审计通过
- [ ] 性能指标达标
- [ ] 文档完整且准确
- [ ] 支持中文和英文
- [ ] 在 Windows, macOS, Linux 上运行正常
