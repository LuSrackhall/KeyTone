# 签名管理功能规格说明

本文档定义签名管理功能的需求变更（Requirement Deltas），遵循 OpenSpec 规范。

## ADDED Requirements

### CATEGORY: 签名管理核心功能

#### Scenario: 用户创建新签名

**Given**：用户想要为自己的作品创建数字签名

**When**：用户打开签名管理页面并点击"创建签名"按钮

**Then**：系统应该：

- 显示签名创建对话框
- 要求用户输入签名名称（必填，1-50 字符）
- 允许用户输入个人介绍（选填，0-500 字符）
- 允许用户上传名片图片（选填，支持 PNG/JPG/JPEG/GIF，最大 5MB）
- 如果上传了图片，显示缩略图预览（120x120px）
- 点击缩略图可放大预览
- 不显示保护码（UI 中完全不可见）
- 提供"创建"和"取消"按钮

**And**：用户填写完信息并点击"创建"

**Then**：系统应该：

- 验证输入数据（名称非空、图片格式和大小符合要求）
- 将图片转为 Base64（如果有）
- 调用后端 `/signature/create` API
- 后端生成签名 ID 和保护码（前端无需处理）
- 后端保存图片文件并加密存储签名数据
- **配置文件更新后，现有 SSE 机制自动推送全量配置数据**（无需额外实现）
- 显示创建成功提示
- 关闭对话框
- **前端 SSE 监听器接收全量数据并自动更新签名列表**（无需手动刷新）

**Acceptance Criteria**：

- ✅ 创建的签名立即出现在签名列表中
- ✅ 保护码由后端生成，前端 UI 中不可见
- ✅ 名片图片通过 `/signature/image/:filename` 接口正确显示
- ✅ 创建失败时显示友好的错误提示

---

### CATEGORY: 缺陷修复与稳定性

### Requirement: 创建成功后列表不应被清空
当用户通过创建对话框成功创建签名后，系统必须保持并合并已有签名列表，立即可见新建项。

#### Scenario: 创建签名后列表仍然完整
- **WHEN** 用户点击创建并后端返回成功
- **THEN** 关闭创建对话框并显示“创建成功”提示
- **AND** 列表包含原有签名项与新创建的签名项
- **AND** 无需重启应用即可看到新项
- **AND** SSE 全量配置抵达时不会将列表误置空

**Acceptance Criteria**：

- ✅ 创建成功后本地状态不会被重置为空数组
- ✅ SSE 合并策略稳定，不丢失既有元素
- ✅ 新项在 1s 内可见

---

### Requirement: 图片目录应初始化至 ConfigPath
签名图片的父目录必须位于应用配置路径 ConfigPath 下（如 ConfigPath/signatures/card_images）。模块应在主进程初始化时接收并设置该路径。

#### Scenario: 签名模块使用 ConfigPath 初始化
- **WHEN** 应用启动，主模块提供 ConfigPath
- **THEN** 调用签名模块初始化函数传入 ConfigPath
- **AND** 所有图片读写基于该路径执行
- **AND** 项目执行的当前工作目录下不再创建 signatures/

**Acceptance Criteria**：

- ✅ 运行期 signatures 目录仅存在于 ConfigPath 下
- ✅ 新增图片写入路径正确
- ✅ 旧路径下不产生残留

---

### Requirement: 删除签名操作应成功反馈
纠正删除接口调用与响应处理，删除成功后不出错，失败时有明确提示。

#### Scenario: 删除签名成功
- **WHEN** 用户点击删除并在确认对话框中选择确定
- **THEN** 调用 DELETE /signature/delete/:id
- **AND** 后端返回 200/204
- **AND** 前端显示“删除成功”提示，列表移除该项

#### Scenario: 删除签名失败
- **WHEN** 后端返回 4xx/5xx 错误
- **THEN** 前端显示“删除失败”通知并保留该项
- **AND** 记录错误日志

**Acceptance Criteria**：

- ✅ 成功删除不再弹出失败提示
- ✅ 失败时不出现成功提示
- ✅ 列表状态与服务端一致

---

### Requirement: 更新签名操作应成功反馈
纠正更新接口调用负载与响应处理，支持部分字段更新并在成功时正确提示。

#### Scenario: 更新签名成功
- **WHEN** 用户在编辑对话框点击更新
- **THEN** 调用 PUT /signature/update，负载包含 id、intro（可选）与 cardImage Base64（可选）
- **AND** 后端成功更新并返回 200
- **AND** 前端显示“更新成功”，对话框关闭，列表刷新或由 SSE 驱动更新

#### Scenario: 更新签名失败
- **WHEN** 后端返回错误
- **THEN** 前端显示“更新失败”，对话框保持打开以便修正
- **AND** 记录错误日志

**Acceptance Criteria**：

- ✅ 成功更新不再弹出失败提示
- ✅ 支持仅更新介绍或图片
- ✅ SSE 或本地状态刷新后数据一致

---

### Requirement: 编辑对话框重复打开应保留正确数据
修复编辑对话框在关闭后再次打开为空的问题，确保每次打开均按当前选择项正确初始化。

#### Scenario: 二次打开编辑对话框数据正确
- **WHEN** 用户关闭对话框后再次点击同一签名的编辑
- **THEN** 对话框按签名 id 重新填充 name、intro、图片预览
- **AND** 名称字段为只读
- **AND** 图片预览可用

**Acceptance Criteria**：

- ✅ 二次打开不再显示空表单
- ✅ 表单与列表项数据一致
- ✅ 对话框每次打开均触发受控初始化

---

#### Scenario: 用户编辑已有签名

**Given**：用户已创建至少一个签名

**When**：用户在签名列表中点击某个签名项

**Then**：系统应该：

- 显示签名编辑对话框
- 预填充当前签名数据
- 签名名称字段为只读（显示灰色）
- 个人介绍字段可编辑
- 名片图片可重新上传
- 如果有名片图片，显示缩略图预览
- 点击缩略图可放大预览
- 不显示保护码（UI 中完全不可见）
- 提供"更新"和"取消"按钮

**And**：用户修改个人介绍或名片图片并点击"更新"

**Then**：系统应该：

- 验证修改后的数据
- 将新图片转为 Base64（如果有）
- 调用后端 `/signature/update` API
- 后端保存新图片并更新加密存储的签名数据
- **配置文件更新后，现有 SSE 机制自动推送全量配置数据**（无需额外实现）
- 显示更新成功提示
- 关闭对话框
- **前端 SSE 监听器接收全量数据并自动更新签名列表**（无需手动刷新）

**Acceptance Criteria**：

- ✅ 签名名称不可修改
- ✅ 个人介绍可以修改
- ✅ 名片图片可以更换
- ✅ 保护码由后端维护，前端无需处理
- ✅ 更新后的数据立即在列表中显示

---

#### Scenario: 用户删除签名

**Given**：用户已创建至少一个签名

**When**：用户在签名列表项上点击"删除"图标

**Then**：系统应该：

- 显示确认对话框
- 提示"确定要删除此签名吗？"
- 提供"确定"和"取消"按钮

**And**：用户点击"确定"

**Then**：系统应该：

- 从签名管理器中移除该签名
- 调用 `DELETE /signature/delete/:id` API
- 后端删除加密存储的签名数据
- **配置文件更新后，现有 SSE 机制自动推送全量配置数据**（无需额外实现）
- 显示删除成功提示
- **前端 SSE 监听器接收全量数据，签名自动从列表中移除**（无需手动操作）

**And**：删除操作失败时

**Then**：系统应该：

- 显示删除失败提示
- 保持签名列表不变
- 记录错误日志

**Acceptance Criteria**：

- ✅ 删除前必须确认
- ✅ 删除成功后签名立即从列表中消失
- ✅ 删除失败时显示错误提示
- ✅ 后端 API 返回错误时不显示成功提示

---

#### Scenario: 用户查看签名列表

**Given**：用户打开签名管理页面

**When**：页面加载完成

**Then**：系统应该：

- 调用 `GET /signature/list` API 获取所有签名
- 后端解密签名数据并返回
- 以网格布局显示所有签名
- 每个签名卡片显示：
  - 签名名称（大字体）
  - 个人介绍（小字体，最多显示 2 行）
  - 名片图片缩略图（通过 `/signature/image/:filename` 获取）
  - 操作按钮（编辑、删除、导出）
- 点击缩略图可放大预览

**And**：签名列表为空时

**Then**：系统应该：

- 显示空状态提示："暂无签名，点击上方按钮创建第一个签名"
- 显示创建签名的引导图标

**And**：数据加载失败时

**Then**：系统应该：

- 显示错误提示
- 提供"重试"按钮
- 记录错误日志

**Acceptance Criteria**：

- ✅ 签名按 ID 或名称排序
- ✅ 支持响应式布局（自动调整列数）
- ✅ 图片通过 HTTP 接口正确加载和显示
- ✅ 图片加载失败时显示占位图
- ✅ 加载过程中显示骨架屏或加载动画

---

### CATEGORY: 签名导入/导出功能

#### Scenario: 用户导出签名

**Given**：用户已创建至少一个签名

**When**：用户在签名列表项上点击"导出"按钮

**Then**：系统应该：

- 调用 `window.showSaveFilePicker()` API 打开文件保存对话框
- 默认文件名为 `{签名名称}.ktsign`
- 文件类型过滤器为 `.ktsign`

**And**：用户选择保存位置并点击"保存"

**Then**：系统应该：

- 调用后端 `GET /signature/export/:id` API
- 后端生成 .ktsign 文件内容（JSON 格式）：
  - 包含文件版本号（"1.0.0"）
  - 包含完整的签名数据
  - 图片转为 Base64 编码嵌入
  - 计算签名数据的 SHA-256 校验和
- 前端接收 JSON 数据
- 使用 `window.showSaveFilePicker()` 将数据写入用户选择的位置
- 显示导出成功提示

**And**：用户取消文件保存

**Then**：系统应该：

- 不显示任何提示
- 不执行导出操作

**And**：浏览器不支持 `window.showSaveFilePicker()`

**Then**：系统应该：

- 降级使用 `<a download>` 方式下载文件

**Acceptance Criteria**：

- ✅ 导出的文件是有效的 JSON 格式
- ✅ 包含完整的签名数据（ID、名称、介绍）
- ✅ 图片以 Base64 格式嵌入（格式：data:image/png;base64,...）
- ✅ 校验和正确计算
- ✅ 只有在用户确认保存后才显示成功提示
- ✅ 支持旧浏览器降级方案

---

#### Scenario: 用户导入签名

**Given**：用户有一个 `.ktsign` 文件

**When**：用户点击"导入签名"按钮并选择文件

**Then**：系统应该：

- 读取文件内容
- 调用后端 `POST /signature/import` API，传递文件内容
- 后端验证文件格式（必须是有效的 JSON）
- 后端验证文件版本号
- 后端验证必填字段（id, name）
- 后端计算签名数据的 SHA-256 校验和
- 与文件中的 `checksum` 字段比较

**And**：文件格式有效且校验和正确

**Then**：系统应该：

- 后端检查签名 ID 是否已存在
- 如果不存在，直接导入：
  - 将 Base64 图片解码并保存到文件系统
  - 生成新的保护码
  - 加密并存储签名数据
- 如果已存在，返回 `exists: true`
- 前端显示覆盖确认对话框（如果已存在）

**And**：用户确认覆盖

**Then**：系统应该：

- 前端调用 `/signature/import` 并设置 `overwrite: true`
- 后端用新数据覆盖旧签名
- 后端将 Base64 图片解码并保存
- 后端生成新的保护码
- 后端加密并保存到配置文件
- **配置文件更新后，现有 SSE 机制自动推送全量配置数据**（无需额外实现）
- 显示导入成功提示
- **前端 SSE 监听器接收全量数据并自动更新签名列表**（无需手动刷新）

**And**：文件格式无效或校验和不匹配

**Then**：系统应该：

- 显示错误提示："签名文件格式无效" 或 "签名文件已损坏或被篡改"
- 不执行导入操作

**Acceptance Criteria**：

- ✅ 只接受 `.ktsign` 文件
- ✅ 严格验证文件格式和内容
- ✅ 校验和验证通过才允许导入
- ✅ 签名 ID 冲突时必须提示用户
- ✅ 导入失败时显示具体的错误原因

---

### CATEGORY: 专辑签名集成

#### Scenario: 用户为专辑添加签名

**Given**：用户准备导出一个专辑

**When**：用户在专辑导出页面点击"导出"按钮

**Then**：系统应该：

- 检查是否有可用的签名
- 如果没有签名，跳过签名选择步骤
- 如果有签名，显示签名选择对话框

**And**：签名选择对话框显示

**Then**：对话框应该：

- 列出所有可用的签名
- 每个签名显示名称、介绍、名片图片缩略图
- 支持单选（一个专辑只能有一个签名）
- 提供"不签名"选项
- 提供"管理签名"按钮（打开签名管理对话框）
- 提供"确定"和"取消"按钮

**And**：用户选择一个签名并点击"确定"

**Then**：系统应该：

- 将签名信息嵌入专辑文件
- 专辑文件中包含：
  - 签名 ID
  - 签名名称
  - 签名时间（当前时间）
  - 加密的保护码
- 继续执行专辑导出流程

**And**：用户选择"不签名"

**Then**：系统应该：

- 不在专辑文件中包含签名信息
- 直接继续执行专辑导出流程

**Acceptance Criteria**：

- ✅ 专辑文件中的签名信息格式正确
- ✅ 签名时间为导出时的时间戳
- ✅ 保护码经过加密处理
- ✅ 未签名的专辑文件不包含 `signatures` 字段

---

#### Scenario: 用户查看已签名的专辑

**Given**：用户有一个包含签名的专辑文件

**When**：用户导入或查看该专辑

**Then**：系统应该：

- 读取专辑文件中的签名信息
- 显示签名状态："已签名"
- 显示签名详情：
  - 签名者名称
  - 签名时间
  - （可选）签名者介绍
  - （可选）签名者名片图片

**And**：专辑文件中没有签名信息

**Then**：系统应该：

- 显示签名状态："未签名"

**Acceptance Criteria**：

- ✅ 正确解析签名信息
- ✅ 时间格式友好显示（如 "2025年10月15日 10:30"）
- ✅ 签名信息不可修改（只读展示）

---

### CATEGORY: 数据安全与加密

#### Scenario: 后端加密存储签名数据

**Given**：前端创建或更新一个签名

**When**：前端调用 `/signature/create` 或 `/signature/update` API

**Then**：后端应该：

- 接收前端发来的签名数据（包含 Base64 图片）
- 生成或保留签名 ID
- 生成保护码（创建时）或保留原保护码（更新时）
- 将 Base64 图片解码并保存到文件系统
- 使用 AES-256-GCM 算法加密签名数据
- 使用固定密钥 `KeyTone2024SecretKey_SignatureProtection`
- 分别加密签名 ID 和签名数据
- 将加密后的 ID 作为 key
- 将加密后的签名数据作为 value
- 存储到 `KeyToneSetting.json` 的 `signature_manager` 字段

**Acceptance Criteria**：

- ✅ 使用 AES-256-GCM 模式
- ✅ 配置文件中的数据不可直接读取
- ✅ 加密过程在后端完成，前端无需处理

---

#### Scenario: 后端解密签名数据

**Given**：前端需要读取签名列表

**When**：前端调用 `GET /signature/list`

**Then**：后端应该：

- 从配置文件读取加密的签名管理器对象
- 遍历所有 key-value 对
- 使用相同的密钥解密 key 得到签名 ID
- 使用相同的密钥解密 value 得到签名数据
- 解析 JSON 得到签名对象
- 返回完整的未加密签名列表（前端可直接使用）

**And**：解密失败时

**Then**：后端应该：

- 记录错误日志
- 跳过损坏的签名数据
- 继续处理其他签名
- 在响应中添加警告字段

**Acceptance Criteria**：

- ✅ 解密算法与加密算法对应
- ✅ 部分数据损坏不影响其他签名的读取
- ✅ 解密错误有详细的日志记录
- ✅ 前端接收到的是未加密的可用数据

---

### CATEGORY: SSE 数据同步

#### Scenario: 签名数据通过 SSE 实时同步

**Given**：用户在一个窗口中修改了签名

**When**：后端保存签名数据成功（更新配置文件）

**Then**：后端应该：

- **自动通过现有的 `/stream` 端点推送全量配置数据**（现有机制，无需新增代码）
- 全量配置数据中包含更新后的 `signature_manager` 字段

**And**：前端接收到 SSE 推送的全量配置数据

**Then**：前端应该：

- 在现有的 SSE 全量数据处理逻辑中，解构提取 `signature_manager` 字段
- 更新前端签名状态（如 Pinia store 或响应式变量）
- **不需要**重新调用 `GET /signature/list` API（SSE 已提供最新数据）
- Vue 响应式系统会自动刷新所有使用签名数据的组件

**实现说明**：

```typescript
// 在现有的 SSE 监听逻辑中（如 app-store.ts）添加签名数据处理
eventSource.addEventListener('message', (event) => {
  const fullConfig = JSON.parse(event.data);  // 后端推送的全量配置

  // 现有逻辑：处理其他配置...
  
  // 新增逻辑：处理签名数据
  if (fullConfig.signature_manager) {
    signatureStore.updateSignatures(fullConfig.signature_manager);
  }
});
```

**Acceptance Criteria**：

- ✅ 多窗口/多标签页之间数据自动同步
- ✅ SSE 连接断开时自动重连（现有机制）
- ✅ 数据更新后 UI 立即刷新
- ✅ **不需要**单独的 `signature_updated` 标志
- ✅ **不需要**调用 API 重新获取签名列表
- ✅ 复用现有的 SSE 全量数据推送机制

---

### CATEGORY: UI/UX 需求

#### Scenario: 图片预览和放大功能

**Given**：签名包含名片图片

**When**：用户在创建/编辑表单或签名列表中看到图片缩略图

**Then**：系统应该：

- 显示缩略图（约 120x120px）
- 图片通过 `/signature/image/:filename` HTTP 接口加载
- 在缩略图上显示提示文字"点击放大"
- 提供点击事件

**And**：用户点击缩略图

**Then**：系统应该：

- 打开图片预览对话框
- 显示原始尺寸的图片
- 对话框使用 `backdrop-filter="invert(70%)"`
- 支持图片缩放（鼠标滚轮，可选功能）
- 支持图片平移（鼠标拖拽，可选功能）
- 提供"关闭"按钮

**And**：图片加载失败时

**Then**：系统应该：

- 显示占位图或错误图标
- 提示"图片加载失败"

**Acceptance Criteria**：

- ✅ 所有图片统一通过 HTTP 接口加载
- ✅ 缩略图尺寸一致
- ✅ 点击放大功能正常工作
- ✅ 预览对话框背景样式正确
- ✅ 图片加载失败有友好提示

---

#### Scenario: 签名列表项布局设计

**Given**：用户查看签名列表

**When**：签名列表显示所有已创建的签名

**Then**：系统应该：

- 每个签名列表项的布局为：**图片在左侧，其他内容在右侧**
- 具体布局结构：
  - 左侧：名片图片缩略图（约 80x80px）
    - 仅显示小尺寸图像
    - 点击小图像打开预览对话框，查看大图
  - 右侧：签名信息（占据列表项主要空间）
    - 标题：签名名称（大字体，粗体）
    - 副标题：个人介绍（小字体，灰色，最多 2 行，超出显示省略号）
  - 图片区域右侧：操作按钮
    - 编辑按钮
    - 删除按钮
    - 导出按钮
- 名片图片的点击区域
  - 点击小图像 → 打开图片预览对话框（查看大图）
  - 不再在列表项点击时进入编辑模式

**And**：用户点击签名名称或个人介绍区域

**Then**：系统应该：

- 打开签名编辑对话框
- 进入编辑模式
- 可修改名称（注：实际只能修改介绍，名称为只读）、介绍、图片

**Acceptance Criteria**：

- ✅ 名片图片仅在左侧作为小图标显示
- ✅ 签名名称和介绍为列表项的主要信息展示
- ✅ 点击小图像打开预览大图
- ✅ 点击签名信息区域进入编辑
- ✅ 列表项高度适中（约 100-120px）
- ✅ 响应式布局保持一致性

---

#### Scenario: 编辑签名对话框中的图片预览位置

**Given**：用户打开编辑签名对话框

**When**：对话框显示时

**Then**：系统应该：

- 对话框内容布局：
  - 上方：表单字段（签名名称只读、个人介绍可编辑）
  - 中间：图片选择器
    - 按钮显示"选择图片"
    - 支持点击或拖拽上传
    - 支持所有 webview 支持的图片格式
  - **下方**：图片快速预览区域
    - 显示已选择的图片的缩略图（约 120x120px）
    - **快速预览图片区域可点击**，点击打开大图预览对话框
    - 如果没有选择图片，显示"暂无图片"提示

**And**：用户点击快速预览区域中的图片

**Then**：系统应该：

- 打开图片预览对话框
- 显示完整尺寸的图片
- 用户可以查看高分辨率版本

**Acceptance Criteria**：

- ✅ 图片快速预览显示在图片选择器下方（而不是上方）
- ✅ 快速预览区域可点击，触发大图预览
- ✅ 预览流畅无延迟
- ✅ 表单布局清晰有序

---

#### Scenario: 创建签名对话框中的图片预览位置

**Given**：用户打开创建签名对话框

**When**：对话框显示时

**Then**：系统应该：

- 对话框内容布局同编辑对话框：
  - 上方：表单字段（签名名称、个人介绍）
  - 中间：图片选择器
    - 按钮显示"选择图片"
    - 支持点击或拖拽上传
    - 支持所有 webview 支持的图片格式
  - **下方**：图片快速预览区域
    - 显示已选择的图片的缩略图（约 120x120px）
    - **快速预览图片区域可点击**，点击打开大图预览对话框
    - 如果没有选择图片，显示"暂无图片"提示

**And**：用户在创建表单中选择了图片

**Then**：系统应该：

- 立即在下方快速预览区域显示该图片
- 用户可以通过点击预览图片来确认是否为正确的图片

**Acceptance Criteria**：

- ✅ 图片快速预览显示在图片选择器下方
- ✅ 快速预览区域可点击，触发大图预览
- ✅ 图片显示流畅
- ✅ 表单布局与编辑对话框保持一致

---

#### Scenario: 图片格式支持范围

**Given**：用户选择要上传的名片图片

**When**：用户点击图片选择器或拖拽图片到选择区域

**Then**：系统应该：

- 支持所有 webview（Chromium）原生支持的图片格式，包括但不限于：
  - JPEG / JPG
  - PNG
  - GIF
  - WebP
  - BMP
  - SVG
  - TIFF
- 去除严格的格式限制
- 不严格限制文件类型检查，允许用户选择任何图片格式
- 后端负责验证图片的有效性

**And**：用户选择了不支持的格式

**Then**：系统应该：

- 尝试加载图片
- 如果 webview 不支持该格式，显示"不支持的图片格式"提示
- 允许用户重新选择

**Acceptance Criteria**：

- ✅ 所有 Chromium 支持的图片格式都可用
- ✅ 格式支持列表与 webview 保持同步
- ✅ 用户不受人为的格式限制影响
- ✅ 无效格式时有友好提示

---

#### Scenario: 页面和对话框模式适配

**Given**：KeyTone 应用窗口尺寸固定

**When**：签名管理组件在页面模式或对话框模式下显示

**Then**：组件应该：

- 使用响应式布局（Quasar 栅格系统）
- 页面模式：
  - 占据完整页面空间
  - padding: 24px
  - height: 100%
- 对话框模式：
  - 最大高度 80vh
  - padding: 16px
  - 内容可滚动（overflow-y: auto）
  - 使用 `backdrop-filter="invert(70%)"`

**Acceptance Criteria**：

- ✅ 同一组件可同时适配页面和对话框模式
- ✅ 布局在固定窗口尺寸下正常显示
- ✅ 对话框模式下内容过长时可滚动
- ✅ 样式在两种模式下都符合设计规范

---

#### Scenario: 对话框样式一致性

**Given**：签名管理功能包含多个对话框

**When**：任何对话框打开时

**Then**：所有对话框应该：

- 使用 `backdrop-filter="invert(70%)"` 属性
- 背景为 70% 反色效果
- 提高多对话框叠加时的视觉层次
- 保持与项目其他对话框的视觉一致性

**Acceptance Criteria**：

- ✅ 所有签名相关对话框都使用 `backdrop-filter="invert(70%)"`
- ✅ 视觉效果与 `SignatureSelectDialog.vue` 一致

---

#### Scenario: 响应式设计

**Given**：用户在不同尺寸的设备上使用应用

**When**：用户打开签名管理页面

**Then**：页面布局应该：

- 大屏（> 1200px）：每行显示 4 个签名卡片
- 中屏（768px - 1200px）：每行显示 3 个签名卡片
- 小屏（< 768px）：每行显示 2 个签名卡片
- 移动端（< 480px）：每行显示 1 个签名卡片

**And**：对话框在小屏幕上

**Then**：对话框应该：

- 自动全屏或接近全屏显示
- 按钮布局调整为垂直排列
- 表单字段宽度自适应

**Acceptance Criteria**：

- ✅ 所有屏幕尺寸下内容都可读、可操作
- ✅ 不出现横向滚动条
- ✅ 触摸设备上按钮大小适合触摸操作（最小 44x44px）

---

### CATEGORY: 国际化需求

#### Scenario: 多语言支持

**Given**：应用支持中文和英文

**When**：用户切换语言

**Then**：所有签名相关的文本都应该：

- 立即切换到对应语言
- 包括：
  - 页面标题
  - 按钮文本
  - 表单标签
  - 提示消息
  - 错误消息
  - 确认对话框文本

**Acceptance Criteria**：

- ✅ 中文翻译准确、自然
- ✅ 英文翻译语法正确、专业
- ✅ 不出现翻译键直接显示的情况
- ✅ 日期时间格式符合当前语言习惯

---

### CATEGORY: 错误处理需求

#### Scenario: 网络错误处理

**Given**：用户执行签名操作

**When**：网络请求失败

**Then**：系统应该：

- 显示友好的错误提示："网络连接失败，请检查网络后重试"
- 提供"重试"按钮
- 不修改本地数据
- 记录错误日志

**Acceptance Criteria**：

- ✅ 网络错误不导致数据丢失
- ✅ 错误提示用户友好，不显示技术细节
- ✅ 提供明确的恢复操作建议

---

#### Scenario: 文件格式错误处理

**Given**：用户尝试导入签名文件

**When**：文件格式不符合规范

**Then**：系统应该：

- 识别具体的错误类型：
  - 非 JSON 格式
  - 缺少必填字段
  - 字段类型错误
  - 校验和不匹配
- 显示对应的错误提示
- 不执行导入操作

**Acceptance Criteria**：

- ✅ 错误提示准确定位问题
- ✅ 提供修复建议（如 "请使用有效的 .ktsign 文件"）
- ✅ 不导致应用崩溃

---

#### Scenario: 存储空间错误处理

**Given**：用户上传名片图片

**When**：磁盘空间不足

**Then**：系统应该：

- 捕获存储错误
- 显示错误提示："存储空间不足，无法保存图片"
- 建议用户清理磁盘空间
- 不保存不完整的签名数据

**Acceptance Criteria**：

- ✅ 存储错误不导致数据损坏
- ✅ 用户明确知道失败原因
- ✅ 系统状态保持一致

---

### CATEGORY: 性能需求

#### Scenario: 签名列表加载性能

**Given**：用户有大量签名（> 100 个）

**When**：用户打开签名管理页面

**Then**：系统应该：

- 页面加载时间 < 2 秒
- 使用虚拟滚动或分页（如果签名数量 > 50）
- 图片懒加载（进入视口时才加载）
- 显示加载进度指示器

**Acceptance Criteria**：

- ✅ 100 个签名时页面加载时间 < 2 秒
- ✅ 滚动流畅，无明显卡顿
- ✅ 内存占用合理（< 200MB）

---

#### Scenario: 加密解密性能

**Given**：系统需要加密或解密大量签名数据

**When**：执行加密或解密操作

**Then**：系统应该：

- 单个签名加密/解密时间 < 10ms
- 100 个签名批量操作时间 < 1 秒
- 使用 Web Workers 避免阻塞 UI 线程（如果批量操作）

**Acceptance Criteria**：

- ✅ 加密操作不阻塞 UI
- ✅ 用户感知不到性能问题

---

### CATEGORY: 兼容性需求

#### Scenario: 浏览器兼容性

**Given**：应用基于 Electron

**When**：使用现代浏览器 API（如 `window.showSaveFilePicker()`）

**Then**：系统应该：

- 检测 API 是否可用
- 不可用时提供降级方案
- 确保核心功能在降级情况下仍可用

**Acceptance Criteria**：

- ✅ Electron 31.7.7+ 完整支持
- ✅ 旧版本 Electron 使用降级方案但功能完整

---

#### Scenario: 操作系统兼容性

**Given**：应用需要在多个操作系统上运行

**When**：用户在 Windows、macOS 或 Linux 上使用签名功能

**Then**：所有功能应该：

- 在所有平台上表现一致
- 文件路径处理正确（使用平台无关的 API）
- UI 渲染正常（字体、间距、颜色）

**Acceptance Criteria**：

- ✅ Windows 10/11 完整支持
- ✅ macOS 12+ 完整支持
- ✅ Ubuntu 20.04+ 完整支持

---

## MODIFIED Requirements

无。本提案为新增功能，不修改现有需求。

---

## REMOVED Requirements

无。本提案不移除任何现有功能。

---

## 验收总结

本功能完成后，应满足以下总体验收标准：

### 功能完整性

- [ ] 所有 CRUD 操作正常工作
- [ ] 导入/导出功能正常工作
- [ ] 专辑签名集成正常工作
- [ ] SSE 数据同步正常工作

### 安全性

- [ ] 所有签名数据经过 AES-256 加密
- [ ] 输入验证完整（防止 XSS、注入）
- [ ] 文件上传安全（类型、大小验证）
- [ ] 校验和验证防篡改

### 性能

- [ ] 页面加载时间 < 2 秒
- [ ] 签名操作响应时间 < 500ms
- [ ] 支持 100+ 签名无性能问题

### 用户体验

- [ ] UI 直观易用
- [ ] 错误提示友好清晰
- [ ] 支持中文和英文
- [ ] 响应式设计支持所有屏幕尺寸

### 兼容性

- [ ] Windows、macOS、Linux 正常运行
- [ ] Electron 31.7.7+ 完整支持
- [ ] 向后兼容旧版本配置文件

### 测试覆盖

- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖所有用户路径
- [ ] E2E 测试覆盖关键场景

### 文档

- [ ] 用户文档完整
- [ ] 开发者文档完整
- [ ] API 文档完整
- [ ] CHANGELOG 更新
