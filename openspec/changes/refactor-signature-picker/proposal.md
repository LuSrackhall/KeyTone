# Proposal: 优化签名选择对话框 UI 并接入真实签名数据

## 概述

当前 `SignaturePickerDialog` 的卡片布局将图片放在顶部占用过多空间。本 proposal 通过以下步骤优化：

1. **调整布局**：参考签名管理页面的做法，将图片移到左侧，采用行布局而非列布局
2. **接入真实数据**：将对话框的签名数据从父组件的 mock 数组改为实时从签名管理 store 获取
3. **统一数据流**：保持与签名管理页面一致的解密与排序逻辑，通过 SSE 推送支持增量更新

## 范围

- **仅修改 `components/export-flow/SignaturePickerDialog.vue`** 的 UI 布局和数据获取逻辑
- **不修改** 状态机流程、导出对话框链路或业务逻辑
- **保证兼容性**：保持现有的 props 接口（`visible`, `signatures`），但优先使用真实数据时会自动替代 mock

## 背景

### 当前问题

1. **卡片布局不紧凑**：80px 的图片占据大量高度，导致列表显示效率低
2. **数据为 mock**：在 `Keytone_album_page_new.vue` 中硬编码了 3 个测试签名，无法反映真实数据
3. **排序逻辑分离**：签名管理页面有完整的排序和 SSE 同步，而选择对话框没有复用

### 参考设计

签名管理页面 (`Signature_management_page.vue`) 的卡片设计：
- 左侧固定宽 60px 图片区
- 中间灵活宽度文本区（名称 + 介绍）
- 整体 minHeight 60px，紧凑高效
- 支持 SSE 增量更新和拖拽排序

## 实现概要

### 修改 1：UI 布局优化

```vue
<!-- 新布局：水平行式 -->
<q-card class="row items-center">
  <!-- 左侧图片 60px -->
  <div style="width: 60px; flex-shrink: 0">
    <!-- 图片或占位符 -->
  </div>
  
  <!-- 右侧信息区 -->
  <div class="col flex flex-col justify-center q-pa-xs">
    <!-- 名称 -->
    <!-- 介绍 -->
  </div>
  
  <!-- 选中指示器 -->
</q-card>
```

### 修改 2：接入真实数据

在 `setup()` 中：
1. 导入 `useSignatureStore` 和相关查询函数
2. 对话框打开时调用 `loadSignaturesRealtime()` 获取并解密签名列表
3. 监听 SSE 推送，支持增量更新
4. 保留 `signatures` prop 作为降级方案（给定时用于 mock 测试）

### 修改 3：保持兼容性

- 如果父组件传入 `signatures` prop 且非空，优先使用；否则加载真实数据
- 不改动事件签名（`select`, `createNew`, `cancel`）
- 不改动搜索逻辑（按名称筛选）

## 测试计划

1. **UI 视觉测试**：打开导出流程，到达签名选择对话框，验证卡片布局紧凑，图片在左侧
2. **真实数据测试**：确认显示的签名与签名管理页面一致（名称、介绍、图片）
3. **排序测试**：在签名管理页修改排序后，刷新导出流程，验证选择对话框中的顺序同步
4. **搜索测试**：在选择对话框中搜索签名名称，确认过滤功能正常
5. **空态测试**：无签名时，显示"暂无签名"提示和"新建签名"按钮

## 实现步骤

### Step 1：更新 SignaturePickerDialog 的 UI 布局

- 修改 template，改为行布局
- 调整图片、文本、选中指示器的位置和大小

### Step 2：导入签名管理相关逻辑

- 导入 `useSignatureStore`
- 导入解密和获取图片 URL 的函数

### Step 3：实现 `loadSignaturesRealtime()` 函数

- 复用签名管理页面的解密逻辑
- 支持排序

### Step 4：测试和验证

- 人工测试上述 5 个测试点
- 确保导出流程的其他对话框不受影响

## 相关 Spec

- `spec/signature-management` — 签名数据模型和 API 约定
- `spec/album-export` — 导出流程状态机（不改动）

## 风险与缓解

| 风险                     | 缓解方案                                 |
| ------------------------ | ---------------------------------------- |
| SSE 推送与对话框更新竞态 | 在对话框关闭时注销 SSE 监听              |
| 加载真实数据延迟导致卡顿 | 异步加载，show loading spinner           |
| 旧的 mock 数据依然被使用 | 显式判断 `signatures` 为空才加载真实数据 |

## 合并条件

1. UI 布局验证无误，与签名管理页面保持一致风格
2. 真实数据正确加载和展示
3. 不破坏导出流程的其他功能
4. 人工测试通过上述 5 个测试点
