# 提案：提升签名名片图片清理的安全性（防止密钥不兼容误删）

## Why

当前签名管理会把签名名片图片保存到 `ConfigPath/signature/`，并在启动后执行一次 `CleanupOrphanCardImages`，删除“配置中未引用”的图片文件。

当未来把更多“写死的加密密钥”改为类似“签名受理流程”的构建期私钥注入方案时，不同用户/不同构建产物可能使用不同的 KeyA/动态密钥。此时旧签名配置将无法解密，系统无法解析 `cardImage` 引用路径，清理任务会把所有图片误判为孤立并删除，造成不可恢复的数据丢失。

本提案的目标是：在任何“无法可靠解析签名配置”的情况下，清理逻辑必须保守，宁可不清理垃圾，也不能误删用户图片。

## What Changes

- **修改**：签名图片清理策略从“尽力清理”改为“可证明安全才删除”。
- **新增约束**：当签名配置存在解密/解析失败（包括因密钥不匹配导致的全量失败）时，`CleanupOrphanCardImages` MUST 跳过删除并记录告警日志。
- **保持不变**：图片的保存路径、命名策略、以及签名数据结构（包含 `cardImage` 完整路径）不在本提案中变更。

## Impact

- 影响 specs：`signature-management`
- 影响代码（预期实现阶段）：
  - `sdk/signature/signature.go`（`CleanupOrphanCardImages`）
  - `sdk/server/server.go`（仅与启动任务相关，行为可能不需要改）

## Compatibility

- 该变更不解决“不同密钥构建导致签名数据互不兼容”的根问题；它只确保在不兼容出现时不会触发误删。
- 对现有用户：清理行为会更保守，可能留下更多孤立文件，但避免数据损失。

## Out of Scope

- 引入签名数据的跨密钥迁移/多密钥回退/密钥轮换机制。
- 为用户提供 UI 交互（例如回收站、手动清理按钮、提示弹窗等）。

## Open Questions

1. 未来计划注入的密钥范围是否包含签名管理的 KeyA/KeyB？（如果是，本提案是必要前置）
2. 期望的“安全阈值”是：
   - A) 只要有任何签名条目解密/解析失败，就完全跳过清理（最安全、最简单）
   - B) 允许在“部分失败”时仍清理一部分“可证明孤立”的文件（更复杂，风险更高）
   本提案默认采用 A。
