# **已完成：把“旧有对称加密密钥”接入与授权流一致的构建注入机制，并同步代码+规格+文档（含 proposal/design/tasks/spec）。**  

sdk 与 ktalbum-tools 均已 `go build safe.` 通过。

**1) 我在仓库里定位到的“硬编码对称密钥/secret”与用途（留痕清单）**
- encryption.go  
  - `KeyToneSignatureEncryptionKeyA`（KeyA）：用于加密签名 ID、派生动态密钥（PBKDF2）  
  - `KeyToneSignatureEncryptionKeyB`（KeyB）：用于 `.ktsign` 导入/导出加密
- album.go  
  - `KeyToneAlbumSignatureEncryptionKey`：用于专辑配置 `signature` 字段的“内层 AES-GCM”加密
- enc.go  
  - `FixedSecret`：用于派生专辑配置 AES key：`SHA256(secret + last6(sha1(albumUUID)))`
- server.go  
  - `KeytoneEncryptKeyV1` / `KeytoneEncryptKeyV2`：用于 `.ktalbum` zip body 的版本化 XOR 加/解密  
  - 另有一处硬编码字符串用于签名图片清理（实际逻辑并不依赖该字符串），已改为使用 `signature.GetKeyA()`，避免继续引入新的“写死密钥源”
- header.go  
  - 原 `KeytoneEncryptKey = "KeyTone2024SecretKey"`：用于工具解包/读信息时 XOR 解密 `.ktalbum`

**2) 适配方式（与授权流一致）**
- 默认值仍然保留在源码中（未注入时保持开源构建行为完全不变）
- 支持通过 Go `-ldflags -X` 注入“XOR 混淆后的 hex”
- 运行时对注入值执行 `hex -> xorMask -> plaintext` 解混淆后再参与加/解密  
  - 若误注入明文（非 hex），会回退为“直接使用该字符串”，保证不把构建卡死

**3) 实际改动位置（代码）**
- SDK（注入点 + 解混淆）
  - encryption.go：KeyA/KeyB 从 `const` → `var`，并复用授权流的解混淆策略
  - album.go：专辑 signature 字段密钥从 `const` → `var`
  - enc.go：`FixedSecret` 从 `const` → `var`（可变长度解混淆）
  - server.go：`KeytoneEncryptKeyV1/V2` 从 `const` → `var`；导出时用 `getEncryptKeyByVersion(2)`（明文）而不是直接用变量值
- 工具链（同步支持 v1/v2 + 注入）
  - header.go：新增 `KeytoneEncryptKeyV1/V2` 与 `GetEncryptKeyByVersion`
  - extract.go、info.go：按 header.Version 选 key，校验失败回退尝试 v1（与 SDK 行为一致）
- 构建注入入口
  - setup_build_env.sh：新增 KEY_A/KEY_B/KEY_ALBUM_* 映射
  - private_keys.template.env：新增对应 KEY_* 模板项

**4) 文档与规格同步（你要求的 proposal/design/tasks/spec 全部覆盖）**
- 文档： BUILD_COMPATIBILITY.md 增加 “Build-Time Injected Keys” 列表
- OpenSpec（新能力规格 + 变更留痕）
  - spec.md（新 capability：Encrypted Outputs）
  - proposal.md
  - design.md
  - tasks.md
  - spec.md
- 既有规格补充： spec.md 明确 KeyB “可构建注入”

**5) 你审查时最关键的“注入变量名”对照**
- SDK（由 setup_build_env.sh 自动拼 EXTRA_LDFLAGS）
  - `KeyTone/signature.KeyToneSignatureEncryptionKeyA`  ← `KEY_A`
  - `KeyTone/signature.KeyToneSignatureEncryptionKeyB`  ← `KEY_B`
  - `KeyTone/signature.KeyToneAlbumSignatureEncryptionKey` ← `KEY_ALBUM_SIGNATURE_FIELD`
  - `KeyTone/server.KeytoneEncryptKeyV1` ← `KEY_ALBUM_EXPORT_V1`
  - `KeyTone/server.KeytoneEncryptKeyV2` ← `KEY_ALBUM_EXPORT_V2`
  - `KeyTone/audioPackage/enc.FixedSecret` ← `KEY_ALBUM_CONFIG_SECRET`
- ktalbum-tools（模块路径不同，需要你在 tools 的构建命令里自行 `-ldflags -X`）
  - `ktalbum-tools/utils.KeytoneEncryptKeyV1`
  - `ktalbum-tools/utils.KeytoneEncryptKeyV2`

如果你希望我再把“ktalbum-tools 的构建脚本/说明”也做成和 SDK 一样的 `setup_build_env.sh + private_keys.template.env`（避免你手写 `-ldflags -X`），我可以继续补齐，但会新增文件与文档说明（你确认后我再做）。

已进行更改。