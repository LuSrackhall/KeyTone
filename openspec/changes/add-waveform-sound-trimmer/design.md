# Design: 波形可视化裁剪（Sound Trimmer with Waveform）

## 背景与问题

现有裁剪仅提供毫秒级 start/end 输入。用户缺少“声音分布”的可视化线索，导致：
- 需要反复预览试错才能定位片段；
- 难以快速找到有声段、瞬态（click）、静音段；
- 新用户不知道音频长度与有效区间。

## 设计目标

- **可视化**：展示波形，让用户一眼看到音量起伏与可能的有效区间。
- **可操作**：拖拽选择区间（region），并能精细调整边界。
- **不破坏现有流程**：start/end 输入框继续存在并可用。
- **稳定数据来源**：波形渲染不依赖“播放成功与否”。

## 方案选型

### 方案 A（已确认 / MVP）：后端提供音频流 + 前端解码渲染

- 后端：提供按 `sha256+type` 定位的音频读取接口，返回音频文件 bytes（带上正确 Content-Type）。
- 前端：使用 WebAudio 解码音频，波形组件完成采样与绘制。

优点：
- 实现速度快，前端生态成熟（例如 wavesurfer.js）。
- 无需在 Go 侧实现复杂音频解码与抽样算法。

风险/注意：
- 大文件解码开销较大，需要 loading + 可能的缓存。
- 需要确保 Electron 渲染进程能请求到本地 SDK HTTP 服务（同源/CORS）。

### 方案 B（后续优化）：后端预计算波形峰值（peaks）

- 后端：返回固定采样率的峰值数组（min/max 或 RMS），并可按 zoom 范围分页。
- 前端：仅绘制与交互，不做解码。

优点：
- 性能稳定，可控；对超长音频更友好。

代价：
- Go 侧需要解码多格式音频并实现抽样/缓存（或引入外部工具/库），复杂度与维护成本更高。

## 交互与数据同步

- 波形组件维护一个选区 `[startMs, endMs]`。
- 与现有输入框双向绑定：
  - 用户拖拽选区边界 -> 更新 start/end 输入框。
  - 用户编辑 start/end 输入框 -> 更新选区边界。

### 右键拖拽快速选区（无菜单）

- 背景：当 start/end 接近 0 且两个手柄重叠时，纯拖拽很难“拉开”选区。
- 交互（无菜单）：
  - 右键按下瞬间：将鼠标所在时间点设置为 start；
  - 右键按下后向右拖动：实时更新 end；
  - 松开右键：将松开位置作为 end。
- 约束：
  - 不引入最小选区长度（用户明确不需要）；
  - 为避免浏览器默认右键菜单打断交互，波形区域需要禁用 context menu。

#### 两端指针可调整（仅保留可拖动指针版本）

- 目标：选区两侧的指针（start/end）应始终可拖动调整。
- 实现策略：即使逻辑上出现 `start==end`（例如右键按下瞬间、或用户正在逐个输入 start/end 造成暂时 `end<=start`），
  UI 渲染层 SHOULD 将其非零化为一个极小的区间（例如 1ms），确保 Regions 插件进入“带两侧手柄”的 region 形态。
- 说明：这属于渲染层的可操作性保障，不等价于业务层的“最小裁剪长度限制”。

#### 时间映射（点击位置 -> 时间点）

- 目标：右键按下的瞬间，start 时间点 SHALL 与用户视觉点击位置一致。
- 实现要点：在 zoom/横向滚动存在时，必须使用正确的滚动视窗进行映射。
  - 若错误使用“可视区域宽度”作为分母，会把时间算得异常靠后（用户反馈）。
  - 推荐使用 DOM 的 `scrollLeft/scrollWidth` 进行稳定映射，避免依赖第三方库 API 在不同版本/后端下的语义差异。
  - 公式：`time = (xInView + scrollLeft) / scrollWidth * duration`（并对 [0,duration] clamp）。
- 若能获取音频总时长 `durationMs`：
  - clamp：`0 <= start < end <= duration`。
  - 可提供“贴合静音边界/对齐峰值”的增强，但不作为 MVP 必需。

## 体验打磨（本轮增强）

### 缩放 / 滚动

- 提供可调缩放（zoom），使用户能观察并定位到约 `100ms` 级别的片段边界。
- 波形宽度随 zoom 增大而变长，并支持横向滚动；播放时可自动滚动以保证播放头可见。
- 交互建议：
  - Slider 控制 zoom（主入口，稳定可发现）；
  - `Ctrl + 鼠标滚轮` 作为快捷缩放（可选增强，需保证体验平滑）。

#### 快捷缩放体验（Ctrl + 滚轮）

- 实现 SHOULD 具备：
  - 平滑缩放（建议指数缩放而非固定步进跳变）；
  - 事件节流/合并（例如 requestAnimationFrame），避免触控板高频滚动导致抖动；
  - 以鼠标所在位置为锚点（缩放后该时间点不应大幅漂移），便于精确定位。

#### 波形“静音段显示异常”的说明与处理

- 在某些实现中，若开启波形 normalize（把全曲最大峰值拉满高度），高缩放时底噪会被视觉夸张，
  用户会误以为静音段也有明显波形。
- 本轮实现选择：波形显示 SHOULD 默认关闭 normalize，以呈现更贴近真实相对振幅的波形。

### 提示文案与 i18n

- 波形组件将引入“播放/缩放/加载/降级/提示”等新增 UI 文案，这些文案 SHOULD 全部接入 i18n。
- 至少覆盖中文与英文。
- 提示文案 SHOULD 描述“右键拖拽快速选区”等核心能力，并保持跨平台表述（不引入平台特有的操作提示）。

### 前端试听播放条（不依赖 SDK 播放）

- 目的：提供“剪辑软件式”的试听体验：可暂停、可拖动播放头、可选择播放范围。
- 默认播放范围：**播放全部**（从当前播放头位置开始）；也允许用户切换为“播放选区”。
- 不做循环播放（避免 UI 复杂化与误触）。

### 音量一致性

- SDK 的 `cut.volume` 当前用于 `beep/effects.Volume`（Base=1.6 的指数缩放），并非简单 0~1 线性音量。
- 前端试听播放为了尽量贴近 SDK 的听感，应将 `cut.volume` 映射为线性 gain：
  - `gain = 1.6 ^ volume`
  - 若使用 WebAudio backend，可支持 `gain > 1`；必要时做上限保护以避免爆音。

## SDK 预览播放限制（<= 5000ms）

- 背景：SDK 侧预览播放目前缺少可暂停能力，因此不适合承担长片段试听。
- 策略：
  - SDK 预览播放保留，用于验证“最终播放链路”与音量设置的真实性。
  - 但 SDK 预览播放 **严格限制** 仅支持 `<= 5000ms` 的片段；超过即拒绝。
  - 长片段的定位与试听交互，交由前端试听播放条完成。

## 降级策略

- 若音频加载/解码失败：
  - 展示错误提示；
  - 保留 start/end 数字输入与预览/保存功能，保证任务可完成。

## 依赖与许可证

- 候选：wavesurfer.js（BSD-3-Clause）+ Regions/Timeline/Hover 插件。
- 仅在实现阶段确认最终依赖与版本；提案阶段先以“可替换实现”描述需求，避免锁死技术栈。
