# Tasks: add-waveform-sound-trimmer

> 目标：让用户在“定义声音裁剪”时可视化选择片段，减少试错。

## 1. Scope & UI 入口

- [ ] 在 Step2 定义声音的“创建声音/编辑声音”对话框中确认放置位置与布局（不压缩现有表单可用性）。
- [ ] 明确波形组件的最小交互：加载、缩放/滚动、拖拽选区、选区时间显示。

## 2. 波形数据来源（选一条 MVP 路线）

- [ ] MVP 路线：后端提供音频流读取接口（按 sha256+type 定位当前专辑下 audioFiles），前端使用 WebAudio 解码并渲染波形。
- [ ] 后续可选优化（不纳入 MVP）：后端返回“抽样峰值数据”（min/max 或 RMS），前端仅负责绘制与交互，降低解码成本。

## 3. 前端组件实现

- [x] 引入并封装波形组件（建议使用 wavesurfer.js + Regions/Timeline/Hover 插件，或等价实现）。
- [x] 修复与现有 start/end 输入框双向同步：
  - 拖拽选区 -> 更新 start/end
  - 编辑 start/end -> 更新选区
- [x] 新增交互：右键按下即定起点、拖动实时更新终点、松开定终点（无菜单）。
- [x] 加入边界与校验：start>=0、end>start、end<=duration（如能获取 duration）。
- [x] 增强体验：zoom/滚动（可观察到约 100ms 级别片段）。
- [x] 增强体验：前端试听播放条（播放/暂停、拖动播放头、显示当前时间与选区时长；默认播放全部，支持切换为播放选区；不做循环播放）。
- [x] 前端试听音量参考当前音量设置（尽量贴近 SDK 的 volume 行为）。
- [x] 波形中线音量条：拖动中线可快捷调整 cut.volume，和输入框双向同步。
- [x] 音量 UI 升级为 dB：可视范围 ±18 dB，左侧刻度 0/6/12/18，右侧显示当前 dB，并提示超出范围。
- [x] 音量标尺外置并补齐负刻度（18/12/6/0/-6/-12/-18），超范围提示为普通提示。
- [x] 视觉优化：标尺靠近波形边界，当前 dB 与提示避免重叠，提升整体质感。
- [x] 宽度约束：对话框宽度响应式不超过视口；标尺不通过负向定位溢出到对话框外。
- [x] 视觉取舍：不绘制全宽网格线，仅保留靠近波形边界的刻度数字（可配短刻度）。
- [x] 音量条体验：0 显示在中位（unity 参考线），命中区足够大且拖动不易失效（处理 pointercancel/手势接管）。
- [x] 音量条定位精度：overlay 高度与波形绘制区域一致（排除滚动条），volume=0 精确对齐波形中位。
- [x] 音量条视觉简化：仅保留横线，移除蓝色圆点手柄。
- [x] i18n：波形组件新增 UI 文案接入 i18n（至少中文与英文），并在提示中包含“右键拖拽快速选区”的说明（跨平台表述）。
- [x] 兼容 macOS 缩放快捷键：支持 Control 修饰键识别（外接键盘）并补充平台化提示（Control/Command + 滚轮或触控板捏合）。
- [x] 兜底：macOS 外接键盘 ctrlKey 不稳定时，window 层跟踪 Control/Command 按键状态。
- [x] 移除开发期临时调试 UI（不在交付版本展示内部状态）。
- [ ] 与预览按钮协作：
  - 预览时使用当前选区与音量参数（保持现有 previewSound 行为）。

## 4. 后端支持（如采用路线 A 或 B）

- [x] 提供按 sha256+type 的音频流接口，并明确错误响应：文件不存在、类型不支持、读取失败。
- [x] 确保仅访问当前编辑的专辑目录下 audioFiles，避免路径穿越风险。
- [x] SDK 预览播放模式严格限制 <=5000ms：超限请求返回明确错误。

## 5. 体验打磨

- [ ] 加载态/失败态：显示 skeleton/loading、错误提示与降级（仍可手动输入裁剪）。
- [ ] 缓存：同一音频文件重复打开对话框时，复用波形数据/解码结果（可先做内存级缓存）。
- [x] 波形显示：默认关闭 normalize，避免高缩放下静音段被视觉夸张。
- [x] 缩放手感：优化 `Ctrl + 滚轮` 为平滑缩放，并以鼠标位置为锚点，减少视图跳变。
- [x] 前端试听音量以 SDK 预览为准：不做额外 clamp，保持 Base=1.6 的指数映射。
- [x] 默认 zoom：minPxPerSec 初始值为 50（避免初始过度放大）。
- [x] 音量调整的视觉反馈：使用 wavesurfer 渲染参数（barHeight）做渲染阶段纵向缩放，并用 requestAnimationFrame 合并更新（避免拖动时高频重绘）。
- [x] 修复：高缩放下右键快捷选区可见性（拖动全过程保持选区可见：rAF 合并轻量重绘 + 边缘触发的自动滚动）。
- [x] 优化拖拽体验：播放头拖拽/选区指针拖拽加入“边缘触发”自动滚动（速度渐进）。
- [x] 修复：播放头在自动滚动过程中保持跟手（滚动时 setTime 对齐光标；选区拖拽使用 synthetic pointermove best-effort）。
- [x] 修复：选区两侧指针在自动滚动过程中保持跟手（必要时直接更新 region 的 start/end）。
- [x] 修复：边缘渐进区持续更新光标时间点（避免指针卡在临界线）。
- [x] 优化：左键拖拽在 pointermove 与自动滚动帧内持续更新（确保丝滑跟手）。
- [x] 优化：左键拖拽由组件接管（命中识别播放头/选区/指针），避免内部拖拽冲突导致的卡点。
- [x] 修复：左键拖拽命中识别使用 composedPath + part token（region/handle），避免识别失效导致只能拖播放头。
- [x] 优化：左键自动滚动速度平滑 + 预测 scrollLeft 映射，提升跟手稳定性。
- [x] 播放跟随滚动行为可配置：在设置页新增“键音专辑页相关”分类，提供 paged-jump（默认）和 edge-push 两种模式。
- [x] 修复智能推挤模式播放头抖动：采用单向推挤算法（idealLeft > currentScrollLeft 才前推）。
- [x] 修复暂停后“当前时间”显示与播放头实际位置不符：pause 事件中强制 getCurrentTime 校准。
- [x] 设置持久化链路完整：StoreSet + getConfigFileToUi 中 StoreGet + watch 三环闭合。
- [x] 修复 Dialog 关闭后音频未停止：onBeforeUnmount 中调用 ws.pause()。
- [x] 修复智能推挤模式抖动：使用 Math.round/ceil 强制 scrollLeft 为整数，对齐浏览器渲染层行为。
- [x] 修复播放头抖动：隐藏内置 cursor，使用自定义 overlay 播放头渲染。
- [x] 修复关闭动画卡顿：波形组件改为 v-show 隐藏，before-hide 回调停止音频。
- [x] 修复播放头高频颤动：播放中强制时间单调递增（lastPlayheadSec）以抵消 getCurrentTime 微回跳。
- [x] 关闭时强制停音兜底：watch 监听 v-model 变化并触发 stopPlayback。
- [x] 播放头像素量化：播放头与 scrollLeft 同步取整，移除亚像素抖动。
- [x] 边缘推挤锁定播放头：达到阈值后播放头固定在 85% 位置，背景滚动承载移动。
- [x] 边缘推挤尾部解锁：接近末尾时解除播放头锁定，保持自然滚动速度。
- [x] 手动移动播放头即时显示：左键点击/拖拽时同步更新自定义播放头。
- [x] 停止按钮即时归零：停止后立刻将播放头回到 0 位置并滚动到起点。
- [x] 手动滚动同步播放头：滚动波形时播放头实时更新位置。
- [x] 右键选区首次可见：暂停/停止后首次右键拖拽触发一次轻量 reRender。
- [x] 右键拖拽不中断播放头：拖拽选区时播放头 UI 持续更新。
- [x] 播放头移出视野提示：边缘指示（变短/变浅）提示播放头在屏幕外。
- [x] 手动交互视区优先：手动操作期间暂停推挤/翻页，但播放头持续更新并可移出视野。
- [x] 自动滚动稳定性：区分程序性 scrollLeft 写入与用户滚动，修复 edge-push 视觉跳动。
- [x] 滚动条点击不 Seek：吞掉滚动条 gutter 点击，避免 dragToSeek 触发。
- [x] 松开后追帧动画：手动交互结束后平滑追到实时播放位置。

## 6. 验证

- [ ] 手动验收：
  - 选择不同源文件时波形正确切换。
  - 拖拽选区后，start/end 正确更新且可保存。
  - 直接输入 start/end 后，选区正确跟随。
  - 波形不可用时，仍能完成创建/编辑与预览。
- [ ] 手动验收：
  - 缩放/滚动可用，能定位到约 100ms 级别片段。
  - 前端试听播放条可播放/暂停/拖动播放头，显示当前时间与选区时长。
  - SDK 预览超过 5000ms 会拒绝并提示，引导使用前端试听。
- [x] 运行 `openspec validate add-waveform-sound-trimmer --strict --no-interactive` 通过。
