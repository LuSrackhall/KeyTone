# Change: add-waveform-sound-trimmer（为声音裁剪提供波形可视化选择）

## Why

当前“裁剪定义声音”的交互主要依赖开始/结束时间数字输入。用户无法直观看到音频里“哪里有声音”，只能反复试错，学习成本高且效率低。

## What Changes

- 在键音专辑编辑器 Step2「定义声音」的“创建声音 / 编辑声音”对话框中，新增一个“波形可视化裁剪”组件：
  - 展示所选音频源文件的波形图（可缩放/滚动）。
  - 通过拖拽选区（region）可视化地选择裁剪区间。
  - 选区与现有开始/结束时间输入框双向同步（任一侧修改，另一侧即时更新）。
- 在波形区域支持“右键按下即定起点、拖动实时更新终点、松开定终点”的快速选区交互（无菜单），用于解决“两个指针重叠在开始位置难以拉开”的痛点。
  - 体验要求：在高缩放（zoom 很大）下完成右键选区后，新选区应立即可见（必要时自动滚动到选区范围，并触发一次轻量重绘），不应要求用户通过微调 zoom 才能看到结果。
  - 拖动过程：从右键按下开始到松开结束，选区应持续可见；必要时使用“边缘触发”的自动滚动跟随 end（指针靠近左右边缘才滚动，速度渐进），并对重绘做节流（例如 requestAnimationFrame）。
- 波形组件内新增的所有 UI 文案（播放/缩放/提示/错误降级等） SHALL 接入 i18n，至少覆盖中文与英文；提示文案 SHALL 保持跨平台描述（不使用平台特有操作提示）。
- 在波形组件内提供“前端试听播放条”（不依赖 SDK 播放），以满足：可暂停、可拖动播放头、可选择播放范围（默认播放全部，亦可播放选区）。
- zoom 默认值（minPxPerSec）设置为 `50`，避免初始过度放大影响整体可读性。
- 在波形图中间提供“横向音量指针条”，用户可通过上下拖动来快捷调整当前裁剪的音量（cut.volume）。
  - 当 volume=0 时该指针条与波形中位基准线重合。
  - 调整音量时，波形本体会产生适度的视觉反馈（例如纵向高度变化），符合剪辑软件直觉。
    - 实现优先使用 wavesurfer 的渲染参数（如 `barHeight`）并触发重绘，避免对 canvas 施加 transform 导致的插值伪影（静音中位线变粗/发糊）。
  - UI 约定：音量为 0 时指针条处于中位（unity gain 参考线），提升认知一致性；拖动命中区应足够大且交互稳定。
- SDK 侧预览播放保持存在，但 **严格限制** 仅支持 `<= 5000ms` 的区间：
  - 超过上限时后端拒绝执行并返回明确错误；
  - 前端在用户点击“预览”时也会提前提示，并引导使用前端试听播放条。
- 保持现有“纯数字输入裁剪”能力不变：波形组件是增强能力，而不是替换（避免破坏老用户工作流）。
- 为波形渲染提供稳定的数据来源：后端仅提供音频流（按 sha256+type 定位当前专辑下的音频源文件），前端负责解码与渲染波形。

- 缩放体验打磨：`Ctrl + 鼠标滚轮` 快捷缩放（若启用）应当平滑、可控，并尽量以鼠标位置为锚点，避免缩放时视图跳动。
- 波形显示默认不启用 normalize，避免在高缩放时把底噪“视觉夸张”造成误判。
- 前端试听音量以 SDK 预览为准：保持与 SDK 预览一致的音量映射（Base=1.6 的指数曲线），不做额外 clamp。
- 拖拽体验一致性：播放头拖拽与选区两侧指针拖拽也采用“边缘触发”自动滚动（指针靠近边缘才滚动、速度渐进），与右键快捷选区保持一致手感。
  - 播放头拖拽在自动滚动过程中应保持与光标位置一致，避免“滚动后播放头跳跃/不跟手”。
  - 选区指针拖拽在自动滚动过程中应保持与光标一致；必要时可直接更新 region 以避免拖拽滞后。
  - 边缘渐进区（速度很小）也应持续更新光标对应时间点，避免指针卡在临界线。
  - 左键拖拽应在 pointermove 与自动滚动帧内持续更新位置，确保全程丝滑。
  - 为保证体验一致，可由组件接管左键拖拽（按命中元素判定播放头/选区/指针）并自行更新位置，避免内部拖拽冲突。
  - 命中识别建议使用 composedPath + `part` token（region / region-handle-left/right），确保识别稳定。

## Notes

- 开发过程可能会使用临时调试 UI（例如显示内部状态），但最终交付版本不应包含这些调试提示，以免影响用户体验与翻译维护成本。

## Impact

- Affected specs:
  - keytone-album-editor（新增“波形可视化裁剪”需求）
- Affected code (implementation stage, non-exhaustive):
  - frontend/src/components/keytone-album/dialogs/CreateSoundDialog.vue
  - frontend/src/components/keytone-album/dialogs/EditSoundDialog.vue
  - frontend/src/components/Keytone_album.vue（Context 与预览流程复用）
  - sdk/server/server.go（新增音频流接口）

## Non-goals (本次不做)

- 不做完整 DAW 级编辑（多轨、淡入淡出曲线、频谱编辑等）。
- 不改变 sounds.cut 的数据结构与存储格式。
- 不要求用户必须使用波形组件才能完成裁剪。
- 不提供“按键快捷选区”（用户明确不需要）。
