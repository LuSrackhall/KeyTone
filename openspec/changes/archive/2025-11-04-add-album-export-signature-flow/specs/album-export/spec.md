# Album Export (UI Flow)

## ADDED Requirements

### Requirement: 导出前签名策略与要求对话框（首次导出可选）

系统在“导出键音专辑”前 SHALL 提供“签名确认”对话框：
- 当专辑尚无任何签名痕迹时（首次导出），允许选择“需要签名”或“无需签名”，默认勾选“需要签名”。
- 当用户选择“需要签名”时，流程进入授权策略设置对话链（见后续需求）。
- 当专辑已有签名痕迹（非首次导出）时跳过该对话框，默认要求使用签名。

#### Scenario: 首次导出—选择无需签名

- WHEN 专辑无签名痕迹，用户在对话框中选择“无需签名”并点击“继续”
- THEN 对话框关闭并继续下一导出步骤（无需签名选择）

#### Scenario: 首次导出—选择需要签名

- WHEN 专辑无签名痕迹，用户在对话框中保持“需要签名”选项并点击“继续”
- THEN 对话框关闭并进入“授权策略设置”流程，用于决定是否要求二次创作授权及填写联系方式

#### Scenario: 非首次导出—必须签名

- GIVEN 专辑已有至少一条签名痕迹
- WHEN 用户点击“导出”
- THEN “无需签名”选项不可用（禁用或不显示），流程将要求选择签名

---

### Requirement: 授权策略设置对话链（需签名场景）

当导出流程判定需要签名时，系统 SHALL 通过一组对话框收集“二次创作是否需授权”及联系方式：
- 第一步展示“授权策略选择”对话框，默认推荐“无需授权”，用户可切换为“需要授权”。
- 当用户选择“需要授权”时，第二步 MUST 弹出风险提示确认对话框，提供“返回修改”与“继续”按钮。
- 在用户确认需要授权后，第三步 MUST 要求填写联系人邮箱（必填，格式校验）与可选补充方式，继续按钮仅在邮箱合法时可用。
- 任何一步取消都会终止本次导出流程并回到初始状态。

#### Scenario: 选择无需授权

- WHEN 用户在授权策略选择对话框中保持“无需授权”并点击继续
- THEN 对话链结束，流程直接进入签名选择步骤

#### Scenario: 需要授权并填写联系方式

- WHEN 用户选择“需要授权”并在确认对话框点击继续
- THEN 打开联系方式对话框，邮箱输入通过格式校验后才允许继续
- AND 提交后记录邮箱与补充联系方式，随后进入签名选择步骤

#### Scenario: 授权对话链取消

- WHEN 用户在任意授权策略相关对话框点击“取消”或“返回”
- THEN 终止导出流程，保持原状态不导出

---

### Requirement: 授权门控对话框（在签名选择之前）

当专辑策略标记“二次创作需授权”且当前导出会话未被授权时，系统 SHALL 在签名选择前显示“授权门控”对话框：
- MUST 展示原作者联系方式（来自专辑配置）。
- MUST 提供“导入授权文件”入口；在未导入前，继续按钮 MUST 禁用。
- SHOULD 提供“如何获得授权？”帮助链接。

#### Scenario: 未授权时阻断签名选择

- GIVEN 专辑配置启用了“二次创作需授权”，当前会话尚未导入授权文件
- WHEN 用户点击导出
- THEN 先显示“授权门控”对话框，签名选择未出现

#### Scenario: 导入授权文件后继续

- WHEN 用户通过门控对话框导入授权文件（前端可用占位成功）
- THEN “继续”按钮变为可点击，点击后进入签名选择

#### Scenario: 取消授权门控

- WHEN 用户点击“取消”
- THEN 关闭门控对话框并中止导出流程

---

### Requirement: 签名选择对话框（支持创建新签名）

系统 SHALL 提供“签名选择”对话框用于在导出时选择签名：
- MUST 展示父级提供的签名列表（目标为签名管理数据，包含名称、简介、缩略图）。
- MUST 提供搜索/筛选与空态提示。
- MUST 提供“新建签名”入口，打开签名创建对话框（复用签名管理 UI）。
- MUST 支持选择高亮与确认/取消。

#### Scenario: 从现有签名中选择

- GIVEN 用户已有至少一个签名
- WHEN 打开签名选择对话框并点击某个签名卡片
- THEN 该项被高亮为选中，点击“确认”继续后续导出流程

#### Scenario: 列表为空时引导创建

- GIVEN 签名列表为空
- WHEN 打开签名选择对话框
- THEN 显示空态与“新建签名”按钮，点击后弹出创建对话框

#### Scenario: 新建签名后回流选择

- WHEN 在签名选择对话框内点击“新建签名”并完成创建（或占位成功）
- THEN 新建项出现在列表中并处于选中或可立即选中状态

---

### Requirement: 导出编排状态机（前端流程）

系统 SHALL 编排导出前的对话链路，遵循以下顺序与条件：
1) 点击“导出”触发。
2) 若专辑无签名痕迹 → 弹“签名确认”对话框，可选择直接无签名结束导出流程。
3) 当流程需要签名时 → 依次进入“授权策略选择”→“风险确认”→“联系方式填写”，任何一步取消都终止本次导出。
4) 若策略启用“需授权”且当前会话尚未导入授权文件 → 弹“授权门控”。
5) 当需要选择签名时 → 弹“签名选择”对话框；完成后返回调用方继续真实的导出逻辑（本变更不实现）。

#### Scenario: 零签名且无需签名

- GIVEN 专辑无签名痕迹
- WHEN 用户在“签名确认”中选择“无需签名”并继续
- THEN 直接结束导出前置流程，回调实际导出逻辑

#### Scenario: 零签名且需要签名

- GIVEN 专辑无签名痕迹
- WHEN 用户选择“需要签名”并依次完成授权策略对话链
- THEN 若策略选择需授权且尚未导入授权文件，则先进入授权门控
- AND 授权通过后进入签名选择

#### Scenario: 已有签名（必须签名）

- GIVEN 专辑已有签名痕迹
- WHEN 用户点击导出
- THEN 跳过“签名确认”直接按策略进入授权门控（如需）并打开签名选择

---

### Requirement: 可访问性与 UX 细节

系统 SHALL 提供基本可访问性与良好反馈，至少满足：
- 对话框 MUST 支持键盘可达性（Tab/Shift+Tab、Enter、Esc）。
- 关键操作 MUST 有 Loading/Disabled 态，避免重复提交。
- 输入校验错误 MUST 就地提示并可读（屏幕阅读器友好）。

#### Scenario: 键盘流畅操作

- WHEN 用户使用键盘在对话框中导航
- THEN 焦点可预期移动，Enter 触发主操作，Esc 关闭/返回

#### Scenario: 校验提示

- WHEN 勾选“需授权”但未填写联系方式
- THEN “继续”按钮禁用并提示联系方式必填

---

Note:
- 本变更仅为 UI/UX 规范与前端流转，不要求真实业务逻辑；后续实现可接入后端鉴权、授权文件校验和签名写入。
- 相关能力参考 `changes/add-signature-management/specs/signature-management/spec.md`，本对话框中“新建签名”应复用既有创建 UI 约束（名称必填、图片规格等）。
- 当前测试版签名选择对话框使用占位数据驱动；接入签名管理真实数据时沿用相同组件与状态机流程。
