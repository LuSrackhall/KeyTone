# 设计：签名名片图片清理的“保守删除”策略

## 背景与现状

- 图片存储：创建/更新签名时，后端会把名片图片写入 `ConfigPath/signature/<sha1>.<ext>`，并把 `SignatureData.cardImage` 写成“完整文件路径”。
- 自动清理：SDK 启动约 5 秒后运行一次 `CleanupOrphanCardImages`。
- 现有清理算法：
  1. 遍历签名配置 `config.signature`。
  2. 对每个条目解密并解析 JSON，收集 `cardImage` 作为“有效路径集合”。
  3. 扫描 `ConfigPath/signature/` 下所有文件，删除“不在有效集合中”的文件。

## 问题链路（误删的根因）

当 KeyA（进而动态密钥）变化后：

1. 配置中存在签名条目，但解密全部失败（或 JSON 解析失败）。
2. “有效路径集合”为空或不完整。
3. 清理逻辑把目录内文件全部视为孤立文件并删除。

这类失败在“用户使用不同私钥/密钥打包”的模型下是可预期的，因此必须从策略层面避免不可逆删除。

## 设计目标

- **数据安全优先**：不能因为“无法解密/解析配置”而删除任何用户图片。
- **最小变更**：不引入新 UI、不改变图片命名/存储结构，先用策略修复误删。
- **可观测性**：发生“跳过清理”时要有明确日志，便于定位密钥不兼容。

## 方案对比

### 方案 A（推荐）：任意解密/解析失败则跳过删除

规则：
- 若签名配置为空：允许按现有规则清理（可删除全部）。
- 若签名配置非空：
  - 只要出现任何条目的解密失败或 JSON 解析失败，即认为“引用集合不可信”，本次清理 MUST 不执行任何删除。

优点：
- 最安全、实现最简单。
- 直接阻断“密钥不兼容导致全量误删”的路径。

缺点：
- 当配置部分损坏或个别条目异常时，会暂时放弃清理，留下孤立文件。

### 方案 B：引入独立的明文索引/manifest

思路：把“图片引用集合”维护在一个不依赖 KeyA/动态密钥的明文文件/字段中，让清理不需要解密签名内容。

优点：
- 清理可继续进行，减少垃圾积累。

缺点：
- 引入新的持久化格式与一致性维护点；属于更大范围变更。
- 仍需考虑 manifest 本身损坏/不同构建的兼容性。

## 选择与结论

本提案选择 **方案 A** 作为“自定义密钥适配”的前置安全修复：先确保不会误删数据，再讨论密钥兼容与迁移。

## 验收要点（实现阶段）

- 当存在签名条目但全部解密失败时：清理任务不删除任何图片文件。
- 当仅部分条目解密失败时：同样不删除任何图片文件（保守策略）。
- 当所有条目均可解密并解析时：行为与当前一致，仅删除确认为孤立的文件。
